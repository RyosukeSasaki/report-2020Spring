\documentclass[uplatex,a4j,11pt]{jsarticle}


\renewcommand{\thesection}{\arabic{section}.}
\bibliographystyle{jplain}

\renewcommand{\thesubsection}{\arabic{subsection}}

\usepackage{listings,jlisting}
\usepackage{url}

% 数式
\usepackage{amsmath,amsfonts}
\usepackage{bm}
\usepackage{siunitx}
% 画像
\usepackage[dvipdfmx]{graphicx}
\makeatletter
\def\fgcaption{\def\@captype{figure}\caption}
\makeatother
\newcommand{\mfig}[3][width=15cm]{
\begin{center}
    \includegraphics[#1]{#2}
\fgcaption{#3 \label{fig:#2}}
\end{center}
}


\begin{document}

\title{プログラミング実習 期末レポート}
\author{佐々木良輔}
\date{\today}
\maketitle

\section*{題目：水ロケットのシミュレーションが可能なCFDの開発}
\
\subsection{背景}
水ロケットは圧縮空気で水などの液体を噴射し,その反作用によって飛翔するロケット模型であり,
宇宙工学の教材として世界中で幅広く用いられている.

水ロケットの競技会では,しばしば地上に設置したターゲットを狙って水ロケットを発射し,
どれだけターゲットに近く着地したかを競うことがある.
こうした競技会でより高いスコアを狙う場合,弾道の予測が有効であり,
そのためには水ロケットの推力を予測する必要があるが,
水ロケットの推力を与える計算式は一般に知られていない.

したがって,本研究では水ロケットの推力計算に応用可能なCFDソルバーの開発を行う.
\subsection{ソルバーについて}
水ロケットでは,ノズルから噴射された直後の液体の流れを調べる必要があるため,
数値解析には粒子法を用いる.粒子法とは流体を多数の粒子の集合であるとし,
各粒子について計算を行うことで流体の動きをシミュレートする手法である.
格子法に比べて事前に解析領域を定める必要がない,飛散などの現象を再現できる,メッシュの切り方に依存しないなどの特徴があり,
水ロケットのように多くの飛沫が発生する対象については粒子法が優れていると考えられる.
特に今回は非圧縮性流れを扱うためMPS (Moving Particle Semi-implicit) 法を用いる.\cite{ryuusi}\cite{ELEM13}
MPS法では流体の圧力を粒子数密度を用いて表し,これを一定とするように計算することで非圧縮性を課す.
本研究はCFDソルバーの開発が目的であるので,検証に用いるモデルは図\ref{fig:pixt.jpg}のような簡単な箱の中での液体の挙動をシミュレーションする.
\mfig[width=10cm]{init.eps}{検証モデル(青点:流体粒子,灰点:ダミー粒子,黒点:壁粒子)\cite{ELEM13}}
水は非圧縮性流体とできるので, Navier-Stokes方程式は
\begin{align}
    \label{NSequ}
    \frac{\partial\bm{u}}{\partial t}+(\bm{u}\cdot\nabla)=-\cfrac{1}{\rho}\nabla p+\mu\nabla^2\bm{u}+\bm{f}
\end{align}
ここで$\bm{u}$は速度である.連続の式は
\begin{align}
    \label{cont1}
    \cfrac{\partial\rho}{\partial t}+\rho\nabla\cdot\bm{u}=0\\
    \label{cont2}
    \nabla\cdot\bm{u}=0
\end{align}
したがって
\begin{align}
    \label{NSequ2}
    \frac{\partial\bm{u}}{\partial t}=-\cfrac{1}{\rho}\nabla p+\mu\nabla^2\bm{u}+\bm{f}
\end{align}
と表される.

MPS法では粒子間相互作用モデルを用いる.粒子間相互作用モデルでは重み係数$w$を用いて粒子間の相互作用に重みをつける.
重み係数$w$を以下のように定義する.\cite{sibas}\cite{MPSriron}
\begin{align}
    w(r)=\begin{cases}
        \cfrac{r_e}{r}-1&0\leq r\leq r_e\\
        0&r_e<r
    \end{cases}
\end{align}
$r$は粒子間の距離である.これは粒子間距離が$r_e$以下の粒子同士が相互作用することを表している.
これを用いて粒子数密度$n_i$を以下のように定義する.
\begin{align}
    n_i=\sum_{i\neq j}w(|\bm{r}_i-\bm{r}_j|)
\end{align}
$n_i$が初期条件$n^0$と一致するようにすることで非圧縮性条件を課す.
粒子間相互作用モデルでは各演算子を以下のように離散化する.\cite{soba}
\begin{align}
    \label{grad}
    \langle\nabla f\rangle_i&=\cfrac{d}{n^0}\sum_{i\neq j}\left(\cfrac{f(\bm{x}_j)-f(\bm{x}_i)}{|\bm{x}_j-\bm{x}_i|^2}(\bm{x}_j-\bm{x}_i)w(|\bm{x}_j-\bm{x}_i|)\right)\\
    \label{div}
    \langle\nabla\cdot \bm{u}\rangle_i&=\cfrac{2d}{n^0}\sum_{i\neq j}\cfrac{\bm{u}\cdot(\bm{x}_j-\bm{x}_i)}{|\bm{x}_j-\bm{x}_i|^2}w(|\bm{x}_j-\bm{x}_i|)\\
    \label{lap}
    \begin{split}
    \langle\nabla^2 f\rangle_i&=\cfrac{2d}{\lambda n^0}\sum_{i\neq j}\left(f(\bm{x}_j)-f(\bm{x}_i)\right)w(|\bm{x}_j-\bm{x}_i|)\\
    where~\lambda&=\cfrac{\sum_{i\neq j}|\bm{x}_j-\bm{x}_i|^2w(|\bm{x}_j-\bm{x}_i|)}{\sum_{i\neq j}w(|\bm{x}_j-\bm{x}_i|)}
    \end{split}
\end{align}
ここで$d$は空間の次元であり,今回は$d=2$である.

MPS法はSemi-implicitとあるとおり,陰解法と陽解法を組み合わせて計算する.
陽解法とは,現在のタイムステップの値をのみを用いて次のタイムステップの値を決定する手法である.
一方では陰解法ではまず現在のタイムステップから次のベクトル場を仮に決定し,それに基づいて計算する.
その後,条件を用いて補正するのが陰解法である.
MPS法ではNavier-Stokes方程式の第2項(粘性項)と第3項(外力項)を陽的に解き,第1項(移流項)と連続の式を陰的に解く.

(\ref{grad})から(\ref{lap})式を用いて(\ref{cont2}), (\ref{NSequ2})式の離散化をする.
\begin{align}
    \cfrac{\Delta \bm{u}}{\Delta t}=\left[-\cfrac{1}{\rho}\nabla p\right]^{k+1}+\left[\mu\nabla^2\bm{u}\right]^k+\left[\bm{f}\right]^k\\
    \left[\nabla\cdot\bm{u}\right]^{k+1}=0
\end{align}
$[\phi]^k$は$\phi$のタイムステップ$k$時点での値を指す.移流項,連続の式は陰的に解くため$k+1$ステップである.
$\bm{u}$を移流項,粘性項と外力項成分に分け,それぞれ$\bm{u}^*$, $\bm{u}'$とする.
\begin{align}
    \label{itiko}
    \cfrac{\Delta \bm{u'}}{\Delta t}=\cfrac{\bm{u}^{k+1}-\bm{u}^*}{\Delta t}=\left[-\cfrac{1}{\rho}\nabla p\right]^{k+1}\\
    \label{nisannko}
    \cfrac{\Delta \bm{u^*}}{\Delta t}=\cfrac{\bm{u}^*-\bm{u}^{k+1}}{\Delta t}=\left[\mu\nabla^2\bm{u}\right]^k+\left[\bm{f}\right]^k
\end{align}
ここで$\bm{u}^*$は仮速度であり,移流項での補正を行っていない速度ベクトルである.
(\ref{nisannko})式において未知数は$\bm{u}^*$のみなので,計算することができる.
$u^*$から速度を計算した後,接近した粒子間に弾性衝突を仮定し,速度と位置を修正する.
これを行うことで,後の圧力計算において粒子数密度が以上に高くなるのを避け,時間間隔を大きくすることができる.
また(\ref{itiko})式に辺々$\nabla$をかけると
\begin{align}
    \cfrac{\langle\nabla\cdot\bm{u}\rangle^{k+1}-\langle\nabla\cdot\bm{u}\rangle^{*}}{\Delta t}=-\cfrac{1}{\rho}\langle\nabla^2p\rangle^{k+1}
\end{align}
ここで連続の式から$\langle\nabla\cdot\bm{u}\rangle^{k+1}=0$なので
\begin{align}
    \label{nabnabpr}
    \langle\nabla^2p\rangle^{k+1}=\rho\cfrac{\langle\nabla\cdot\bm{u}\rangle^{*}}{\Delta t}
\end{align}
となる.つぎに(\ref{cont1})式を離散化すると
\begin{align}
    \cfrac{\rho^*-\rho}{\Delta t}+\rho\langle\nabla\cdot\bm{u}\rangle^*&=0\\
    \langle\nabla\cdot\bm{u}\rangle^*&=-\cfrac{1}{\Delta t}\cfrac{\rho^*-\rho}{\rho}
\end{align}
ここで密度$\rho$が粒子数密度$n_i$と比例することを用いて
\begin{align}
    \langle\nabla\cdot\bm{u}\rangle^*\simeq-\cfrac{1}{\Delta t}\cfrac{n^*-n^0}{n^0}
\end{align}
これと(\ref{nabnabpr})式から
\begin{align}
    \label{nabnabpn}
    \langle\nabla^2p\rangle^{k+1}=-\cfrac{\rho^0}{\Delta t^2}\cfrac{n^*-n^0}{n^0}
\end{align}
以上と(\ref{grad})から(\ref{lap})式を用いることで,実際に計算機上で連立方程式として圧力を計算することができる.
よって(\ref{itiko})式, (\ref{nisannko})式が解け,タイムステップの計算が終了する.\cite{ryuusinyuumon}
\subsection{初期状態}
\label{sec:init}
初期状態は図\ref{fig:init.eps}のような箱の中の一部に流体が分布したような状態を考える.
具体的には以下のような条件とする.
\begin{itemize}
    \item 壁面はダミー粒子2層と壁粒子2層から成る
    \item 箱内部の大きさは$0\leq x\leq1$, $0\leq y\leq 0.6$
    \item 流体は$0\leq x\leq0.25$, $0\leq y\leq 0.5$に等間隔で存在
\end{itemize}
\subsection{境界条件}
境界条件として、Dirichlet境界条件とNeumann境界条件を課す.
Dirichlet境界条件とは基準となる液面での圧力を設定するもので,ここでは0 Paを基準圧力とする.
具体的には,粒子数密度が一定以下の粒子が液面にあると判定し,この粒子に対する圧力を0として計算する.
Neumann境界条件とは壁面付近での圧力勾配を0とするもので,粒子が壁面を透過しないことを課す.
具体的には,壁粒子の更に外側にダミー粒子を配置し,この粒子と近傍の粒子の圧力値を等しくすることで近似的にNeumann境界条件を課す.
\subsection{評価手法}
\label{sec:eval}
CFDでは計算点の数が膨大であり,誤差を厳密に定義するのは困難である.
したがって,プログラム・計算結果の正しさについて以下の点で検証する.
\begin{enumerate}
    \item 粒子の初期状態を描画し,これが意図したとおりであることを確認する.
    \item 図\ref{fig:init.eps}のような初期条件において,十分な時間が経過すれば流体が図\ref{fig:end.png}のように箱の中で安定な終状態になることが予想できる.数値計算の結果が実際にそうなることを確認する.
    \item 粒子の大きさを変えて計算を行い,同様な状態に収束することを確認する.
\end{enumerate}
\mfig[width=10cm]{end.png}{終状態}
\subsection{結果・考察}
各シミュレーション結果のgif画像を以下のリンクに示す.

\url{https://drive.google.com/drive/folders/1_8svElxSwZ7_AIx99lqpTLAQhdo7Z8aQ?usp=sharing}
\subsubsection{シミュレーション1}
\label{sec:sim1}
表\ref{tab:sim1}にパラメーターを図\ref{fig:sim1/out0000.eps}に初期状態を示す.
また,図\ref{fig:sim1/out0791.eps}から図\ref{fig:sim1/out0800.eps}に終状態の直前100ステップを示す.

図\ref{fig:sim1/out0000.eps}のように,初期状態は\ref{sec:init}節に示した条件を満たしている.
また,図\ref{fig:sim1/out0791.eps}から図\ref{fig:sim1/out0800.eps}より,
流体は図\ref{fig:end.png}のような終状態で安定な状態になっていることがわかる.
\begin{table}[h]
   \caption{パラメーター}
   \label{tab:sim1}
   \centering
   \begin{tabular}{cc}
     \hline
     名称&値\\
     \hline \hline
     時間間隔$h$&0.0005 \si{\second}\\
     タイムステップ数&8000\\
     粒子間隔(粒子直径)&0.025 \si{\metre}\\
     流体密度&1000 \si{\kilo\gram}\\
     弾性衝突係数$e$&0.2\\
     動粘性係数&$1.0\times10^{-6}$ \si{\metre^{2}.\second^{-1}}\\
     圧縮率&$4.5\times10^{-10}$ \si{\pascal^{-1}}\\
     \hline
   \end{tabular}
\end{table}
\mfig[width=10cm]{sim1/out0000.eps}{初期状態}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0791.eps}{タイムステップ:7910}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0792.eps}{タイムステップ:7920}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0793.eps}{タイムステップ:7930}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0794.eps}{タイムステップ:7940}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0795.eps}{タイムステップ:7950}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0796.eps}{タイムステップ:7960}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0797.eps}{タイムステップ:7970}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0798.eps}{タイムステップ:7980}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0799.eps}{タイムステップ:7990}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim1/out0800.eps}{タイムステップ:8000}
    \end{minipage} 
\end{figure}
\subsubsection{シミュレーション2}
シミュレーション2では粒子の大きさを変更して同様の条件でシミュレーションを行っている.
表\ref{tab:sim2}にパラメーターを図\ref{fig:sim2/out0000.eps}に初期状態を示す.
また,図\ref{fig:sim2/out0791.eps}から図\ref{fig:sim2/out0800.eps}に終状態の直前100ステップを示す.

図\ref{fig:sim2/out0000.eps}のように,初期状態は\ref{sec:init}節に示した条件を満たしている.
また,シミュレーション1と比較すると,粒子のサイズを変更しても同様に\ref{fig:end.png}のような終状態で安定な状態になっているとわかる.
以上から2つの粒子サイズにおける検証で\ref{sec:eval}節に示した条件を満たしており,このプログラムが正常に動作していると言える.
\begin{table}[h]
   \caption{パラメーター}
   \label{tab:sim2}
   \centering
   \begin{tabular}{cc}
     \hline
     名称&値\\
     \hline \hline
     時間間隔$h$&0.0005 \si{\second}\\
     タイムステップ数&8000\\
     粒子間隔(粒子直径)&0.020 \si{\metre}\\
     流体密度&1000 \si{\kilo\gram}\\
     弾性衝突係数$e$&0.2\\
     動粘性係数&$1.0\times10^{-6}$ \si{\metre^{2}.\second^{-1}}\\
     圧縮率&$4.5\times10^{-10}$ \si{\pascal^{-1}}\\
     \hline
   \end{tabular}
\end{table}
\mfig[width=10cm]{sim2/out0000.eps}{初期状態}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0791.eps}{タイムステップ:7910}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0792.eps}{タイムステップ:7920}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0793.eps}{タイムステップ:7930}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0794.eps}{タイムステップ:7940}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0795.eps}{タイムステップ:7950}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0796.eps}{タイムステップ:7960}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0797.eps}{タイムステップ:7970}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0798.eps}{タイムステップ:7980}
    \end{minipage} 
\end{figure}
\begin{figure}[htbp]
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0799.eps}{タイムステップ:7990}
    \end{minipage}
    \begin{minipage}{0.5\hsize}
        \mfig[width=7cm]{sim2/out0800.eps}{タイムステップ:8000}
    \end{minipage} 
\end{figure}
\subsection{結論}
粒子法による流体のシュミレーターの開発に成功した.
\newpage
\bibliography{ref.bib}
\newpage
\input{code.tex}
\end{document}